/*******************************************************************
171707171717171717 RoboMasters(HITCRT_iHiter 091717)
17041717171717 RM_Algorithm.h
1717171710171717171317 2016/1/25
17汾1717 1.0
--------------------------------------------------------------------
00171717171717171717170017E171717031717011717111717
--------------------------------------------------------------------
17100417041717
17171717                              021717         17汾   051717
1717171717171717171705171703171717171717171717    2016/1/25     1.0     171717171717170417
********************************************************************/
#include "main.h"
#include <math.h>
#include <float.h>

/**************************************************************************************************/
/*********************************171701171717171717171711****************************************************/
/**************************************************************************************************/


/*--------------------------------------------------------------------------------------------------
171717171717170317Clip()
17171717171717111717171717171717171717041717171717171717170517171717С05081717170517171717081717171717171717С05
--------------------------------------------------------------------------------------------------*/
FP32 Clip(FP32 fpValue, SINT32 siMin, SINT32 siMax)
{
	if(fpValue < siMin)
	{
		return (FP32)(siMin);
	}
	else if(fpValue > siMax)
	{
		return (FP32)(siMax);
	}
	else 
	{
		return fpValue;
	}
}
/*--------------------------------------------------------------------------------------------------
171717171717170317Round()
171717171717171117171717171717171717171717171717031717171732λ171717171717
--------------------------------------------------------------------------------------------------*/
SINT32 Round(FP32 fpValue)
{   
    if (fpValue >= 0)
    {
    	return (SINT32)(fpValue + 0.5f);
    }
    else 
    {
    	return (SINT32)(fpValue - 0.5f);
    }
}

/*--------------------------------------------------------------------------------------------------
171717171717170317IsNum()
17171717171717111717ж17051717171717171717170917171717171717
--------------------------------------------------------------------------------------------------*/
bool IsNum(DB64 x)
{
	if (x == x)
		return TRUE;
    else
		return FALSE;
}

/*--------------------------------------------------------------------------------------------------
171717171717170317IsFiniteNum()
17171717171717111717ж17051717171717171717170917171717171717041717ж17051717float1707171717NAN0617171717infinite
--------------------------------------------------------------------------------------------------*/
bool IsFiniteNum(DB64 x)
{
	if (x <= DBL_MAX && x >= -DBL_MAX)
		return TRUE;
	else
    	return FALSE;
}


/**************************************************************************************************/
/*********************************PID1717171711****************************************************/
/**************************************************************************************************/


/*--------------------------------------------------------------------------------------------------
171717171717170317CalPID()  
17171717171717111717171717PID1717171717171717171717171717001717PID
          171717171717PID17111704171712041717detU(k)=U(k)-U(k-1)=Kp(detE(k)+IE(k)+fpD*det(E(k))+det(E(k)))
          1717171717171717171704PID:U=U+KP*1717E+KI*E+KD*[E+E(n-2)-2*E(n-1)]
--------------------------------------------------------------------------------------------------*/
void CalPID(volatile ST_PID *pstPid)    
{   
    UCHAR8 ucK;
   
	ucK=1;
	pstPid->U += pstPid->KP * (pstPid->E - pstPid->PreE) + ucK * pstPid->KI * pstPid->E + pstPid->KD * (pstPid->E - 2 * pstPid->PreE + pstPid->PrePreE);
	pstPid->PrePreE = pstPid->PreE;
	pstPid->PreE = pstPid->E;
    
    //17ж1717091717171717170717171717171717171717170717171705021717,171017171701171717171700171717171701171717bug
    if (IsFiniteNum(pstPid->U) != TRUE)
        pstPid->U = 0;

    pstPid->U = Clip(pstPid->U,pstPid->UMin,pstPid->UMax);
}

void CalPID_Su(volatile ST_PID *pstPid)    
{   
    UCHAR8 ucK;
   
	ucK=1;
	pstPid->U = pstPid->KP * pstPid->E + ucK * pstPid->KI * (pstPid->E - pstPid->PreE);
	pstPid->PrePreE = pstPid->PreE;
	pstPid->PreE = pstPid->E;

	if (IsFiniteNum(pstPid->U) != TRUE)
    pstPid->U = 0;

    pstPid->U = Clip(pstPid->U,pstPid->UMin,pstPid->UMax);
}
/*--------------------------------------------------------------------------------------------------
171717171717170317CalPID_IS() :Calculate PID Integral Separation
1717171717171711171717170717171704PID
           171717171717PID17111704171712041717detU(k)=U(k)-U(k-1)=Kp(detE(k)+IE(k)+D*det(E(k))+det(E(k)))
           1717170717171704PID:U=U+KP*1717E+ucK*KI*E+KD*[E+E(n-2)-2*E(n-1)]
           1717170717171704PID17171704170917171701171717
--------------------------------------------------------------------------------------------------*/
void CalPID_IS(volatile ST_PID *pstPid)	
{   
    UCHAR8  ucK;
    
	if (fabs(pstPid->E) > pstPid->ELimit)
	{
		ucK=0; 
	}
	else 
	{
		ucK=1;
	}
	pstPid->U += pstPid->KP * (pstPid->E - pstPid->PreE) 
                 + ucK * pstPid->KI * pstPid->E 
                 + pstPid->KD * (pstPid->E - 2 * pstPid->PreE + pstPid->PrePreE);

	pstPid->PrePreE = pstPid->PreE;
	pstPid->PreE=pstPid->E;
}

/*--------------------------------------------------------------------------------------------------
171717171717170317CalPID_WTCOL()  :Weaken The Case Of Limited
17171717171717111717171717PID17171717171717171717171704PID
          171717171717PID17111704171712041717detU(k)=U(k)-U(k-1)=Kp(detE(k)+IE(k)+fpD*det(E(k))+det(E(k)))
          171717171717171704PID:U=U+KP*1717E+ucK*KI*E+KD*[E+E(n-2)-2*E(n-1)]
          171717171717171704PID171717041709PID17171717171717171717171717,171717171717
--------------------------------------------------------------------------------------------------*/
void CalPID_WTCOL(volatile ST_PID *pstPid)  
{   
    UCHAR8 ucK;
	 
	if (((pstPid->U > pstPid->ULimit) && (pstPid->E > 0)) || ((pstPid->U < -pstPid->ULimit) && (pstPid->E < 0)))//171705171717171617С171717171717170517170217171705051717л171717
	{
	    ucK = 0;
	}
	else
	{ 
		ucK = 1;
	}

	if(abs(pstPid->E) <= pstPid->EDead)
	{
		pstPid->E = 0;
	}
	pstPid->U += pstPid->KP * (pstPid->E - pstPid->PreE) 
                 + ucK * pstPid->KI * pstPid->E 
                 + pstPid->KD * (pstPid->E - 2 * pstPid->PreE + pstPid->PrePreE);
	
	pstPid->PrePreE = pstPid->PreE;
	pstPid->PreE = pstPid->E;
}

/*--------------------------------------------------------------------------------------------------
171717171717170317CalPID_WTCOLIS() 
17171717171717111717171717PID1717
          171717171717PID17111704171712041717detU(k)=U(k)-U(k-1)=Kp(detE(k)+IE(k)+fpD*det(E(k))+det(E(k)))
          17171707171717+171717171717171704PID:U=U+KP*1717E+ucK1*ucK2*KI*E+KD*[E+E(n-2)-2*E(n-1)]
          17171707171717+171717171717171704PID171704171717170717
--------------------------------------------------------------------------------------------------*/
void CalPID_WTCOLIS(volatile ST_PID *pstPid)  
{   
    UCHAR8 ucK1, ucK2;
    
    //1717171717171717
	if (((pstPid->U > pstPid->ULimit) && (pstPid->E > 0)) 
		|| ((pstPid->U < -pstPid->ULimit) && (pstPid->E < 0)))//1717171717170517ε17pstPid171717171717171717ж171709170817л171701171717
	{
	    ucK1=0;
	}
	else
	{ 
		ucK1=1;
	}
	
	//17171707171717
	if (fabs(pstPid->E) > pstPid->ELimit)
	{
		ucK2=0;
	}
	else
	{ 
		ucK2=1;
	}
	
	pstPid->U += pstPid->KP * (pstPid->E - pstPid->PreE) 
                 + ucK1 * ucK2 * pstPid->KI * pstPid->E 
                 + pstPid->KD * (pstPid->E - 2 * pstPid->PreE + pstPid->PrePreE);
	
	pstPid->PrePreE = pstPid->PreE;
	pstPid->PreE = pstPid->E;
}

